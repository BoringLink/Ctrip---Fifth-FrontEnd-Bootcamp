# 易宿酒店预订平台后端系统设计方案

## 1. 用户需求分析

### 1.1 核心功能需求

* **用户端**：
  - 酒店查询
  - 酒店列表展示
  - 酒店详情查看
  - 快捷标签筛选酒店
  - 价格区间筛选
  - 星级筛选

* **管理端**：
  - 用户登录/注册
  - 酒店信息录入/编辑/修改
  - 酒店信息审核/发布/下线
  - 预订管理
  - 房间入住人员信息查询
  - 标签管理

### 1.2 数据维度需求

* **必须维度**：
  - 酒店名(中/英显示)
  - 酒店地址
  - 酒店星级
  - 酒店房型
  - 酒店价格
  - 酒店开业时间

* **可选维度**：
  - 酒店附近的热门景点、交通及商场
  - 酒店价格的打折/优惠场景
  - 酒店属性标签（如亲子、豪华、免费停车场等）
  - 入住人员信息（姓名、证件类型、证件号码、电话号码）

### 1.3 角色需求

* **商户**：
  - 上传/编辑酒店信息
  - 管理酒店房型、图片、设施等
  - 查看酒店预订情况

* **管理员**：
  - 审核/发布/下线酒店信息
  - 管理标签
  - 查询房间入住人员信息
  - 管理所有酒店的预订情况

* **用户**：
  - 查看/查询/筛选酒店
  - 查看酒店详情

## 2. 数据库表结构设计

### 2.1 用户表 (users)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | 用户ID |
| email | VARCHAR(255) | UNIQUE NOT NULL | 邮箱 |
| password | VARCHAR(255) | NOT NULL | 密码（哈希存储） |
| name | VARCHAR(100) | NOT NULL | 用户名 |
| role | user_role | NOT NULL | 角色（merchant/admin） |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新时间 |

**SQL创建语句：**
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    name VARCHAR(100) NOT NULL,
    role user_role NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_users_email ON users(email);
```

### 2.2 酒店表 (hotels)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | 酒店ID |
| name_zh | VARCHAR(255) | NOT NULL | 酒店中文名 |
| name_en | VARCHAR(255) | NOT NULL | 酒店英文名 |
| address | TEXT | NOT NULL | 酒店地址 |
| star_rating | INTEGER | NOT NULL | 酒店星级 |
| opening_date | DATE | NOT NULL | 酒店开业时间 |
| description | TEXT | | 酒店描述 |
| status | hotel_status | NOT NULL | 状态（pending/approved/rejected/offline） |
| rejection_reason | TEXT | | 拒绝原因 |
| merchant_id | UUID | REFERENCES users(id) | 商户ID |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新时间 |

**SQL创建语句：**
```sql
CREATE TABLE hotels (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name_zh VARCHAR(255) NOT NULL,
    name_en VARCHAR(255) NOT NULL,
    address TEXT NOT NULL,
    star_rating INTEGER NOT NULL,
    opening_date DATE NOT NULL,
    description TEXT,
    status hotel_status NOT NULL,
    rejection_reason TEXT,
    merchant_id UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_hotels_status_star ON hotels(status, star_rating);
CREATE INDEX idx_hotels_merchant_status ON hotels(merchant_id, status);
```

### 2.3 酒店房型表 (hotel_rooms)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | 房型ID |
| hotel_id | UUID | REFERENCES hotels(id) | 酒店ID |
| name | VARCHAR(100) | NOT NULL | 房型名称 |
| description | TEXT | | 房型描述 |
| price | DECIMAL(10,2) | NOT NULL | 价格 |
| capacity | INTEGER | NOT NULL | 容纳人数 |
| quantity | INTEGER | NOT NULL | 房间数量 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新时间 |

**SQL创建语句：**
```sql
CREATE TABLE hotel_rooms (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    hotel_id UUID REFERENCES hotels(id),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL,
    capacity INTEGER NOT NULL,
    quantity INTEGER NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_hotel_rooms_hotel_price ON hotel_rooms(hotel_id, price);
```

### 2.4 酒店设施表 (hotel_facilities)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | 设施ID |
| hotel_id | UUID | REFERENCES hotels(id) | 酒店ID |
| name | VARCHAR(100) | NOT NULL | 设施名称 |
| description | TEXT | | 设施描述 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |

**SQL创建语句：**
```sql
CREATE TABLE hotel_facilities (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    hotel_id UUID REFERENCES hotels(id),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 2.5 酒店图片表 (hotel_images)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | 图片ID |
| hotel_id | UUID | REFERENCES hotels(id) | 酒店ID |
| url | VARCHAR(500) | NOT NULL | 图片URL |
| description | TEXT | | 图片描述 |
| is_main | BOOLEAN | DEFAULT false | 是否为主图 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |

**SQL创建语句：**
```sql
CREATE TABLE hotel_images (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    hotel_id UUID REFERENCES hotels(id),
    url VARCHAR(500) NOT NULL,
    description TEXT,
    is_main BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 2.6 酒店优惠表 (hotel_promotions)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | 优惠ID |
| hotel_id | UUID | REFERENCES hotels(id) | 酒店ID |
| name | VARCHAR(100) | NOT NULL | 优惠名称 |
| description | TEXT | | 优惠描述 |
| discount_type | discount_type | NOT NULL | 优惠类型（percentage/fixed/package） |
| discount_value | DECIMAL(10,2) | NOT NULL | 优惠值 |
| start_date | DATE | NOT NULL | 开始日期 |
| end_date | DATE | NOT NULL | 结束日期 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新时间 |

**SQL创建语句：**
```sql
CREATE TABLE hotel_promotions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    hotel_id UUID REFERENCES hotels(id),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    discount_type discount_type NOT NULL,
    discount_value DECIMAL(10,2) NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### 2.7 酒店附近景点表 (hotel_nearby_attractions)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | 景点ID |
| hotel_id | UUID | REFERENCES hotels(id) | 酒店ID |
| name | VARCHAR(100) | NOT NULL | 景点名称 |
| type | attraction_type | NOT NULL | 类型（attraction/transportation/shopping） |
| distance | VARCHAR(50) | | 距离酒店距离 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |

**SQL创建语句：**
```sql
CREATE TABLE hotel_nearby_attractions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    hotel_id UUID REFERENCES hotels(id),
    name VARCHAR(100) NOT NULL,
    type attraction_type NOT NULL,
    distance VARCHAR(50),
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 2.8 酒店标签表 (hotel_tags)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | 标签ID |
| name | VARCHAR(50) | NOT NULL | 标签名称（如亲子、豪华、免费停车场等） |
| description | TEXT | | 标签描述 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |

**SQL创建语句：**
```sql
CREATE TABLE hotel_tags (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(50) NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 2.9 酒店-标签关联表 (hotel_tag_relations)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | 关联ID |
| hotel_id | UUID | REFERENCES hotels(id) | 酒店ID |
| tag_id | UUID | REFERENCES hotel_tags(id) | 标签ID |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |

**SQL创建语句：**
```sql
CREATE TABLE hotel_tag_relations (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    hotel_id UUID REFERENCES hotels(id),
    tag_id UUID REFERENCES hotel_tags(id),
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_hotel_tag_relations_hotel_tag ON hotel_tag_relations(hotel_id, tag_id);
```

### 2.10 预订表 (reservations)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | 预订ID |
| hotel_id | UUID | REFERENCES hotels(id) | 酒店ID |
| room_id | UUID | REFERENCES hotel_rooms(id) | 房型ID |
| check_in_date | DATE | NOT NULL | 入住日期 |
| check_out_date | DATE | NOT NULL | 退房日期 |
| guest_name | VARCHAR(50) | NOT NULL | 客人姓名 |
| guest_phone | VARCHAR(20) | NOT NULL | 客人电话 |
| guest_email | VARCHAR(255) | NOT NULL | 客人邮箱 |
| status | reservation_status | NOT NULL | 状态（confirmed/check_in/check_out/cancelled） |
| total_price | DECIMAL(10,2) | NOT NULL | 总价 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新时间 |

**SQL创建语句：**
```sql
CREATE TABLE reservations (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    hotel_id UUID REFERENCES hotels(id),
    room_id UUID REFERENCES hotel_rooms(id),
    check_in_date DATE NOT NULL,
    check_out_date DATE NOT NULL,
    guest_name VARCHAR(50) NOT NULL,
    guest_phone VARCHAR(20) NOT NULL,
    guest_email VARCHAR(255) NOT NULL,
    status reservation_status NOT NULL,
    total_price DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_reservations_hotel_status_date ON reservations(hotel_id, status, check_in_date, check_out_date);
CREATE INDEX idx_reservations_room_status ON reservations(room_id, status);
```

### 2.11 入住人员表 (guests)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | 入住人员ID |
| name | VARCHAR(50) | NOT NULL | 姓名 |
| id_type | id_type | NOT NULL | 证件类型（id_card/passport/other） |
| id_number | VARCHAR(50) | NOT NULL | 证件号码 |
| phone | VARCHAR(20) | NOT NULL | 电话号码 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新时间 |

**SQL创建语句：**
```sql
CREATE TABLE guests (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(50) NOT NULL,
    id_type id_type NOT NULL,
    id_number VARCHAR(50) NOT NULL,
    phone VARCHAR(20) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_guests_id_number ON guests(id_number);
```

### 2.12 预订-入住人员关联表 (reservation_guests)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | 关联ID |
| reservation_id | UUID | REFERENCES reservations(id) | 预订ID |
| guest_id | UUID | REFERENCES guests(id) | 入住人员ID |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |

**SQL创建语句：**
```sql
CREATE TABLE reservation_guests (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    reservation_id UUID REFERENCES reservations(id),
    guest_id UUID REFERENCES guests(id),
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_reservation_guests_reservation_guest ON reservation_guests(reservation_id, guest_id);
```

## 3. API接口设计

### 3.1 认证接口
- `POST /api/auth/register` - 用户注册
  - 请求体：`{"email": "user@example.com", "password": "password123", "name": "用户名", "role": "merchant"}`
  - 响应：`{"id": "uuid", "email": "user@example.com", "name": "用户名", "role": "merchant", "created_at": "2024-01-01T00:00:00Z"}`

- `POST /api/auth/login` - 用户登录
  - 请求体：`{"email": "user@example.com", "password": "password123"}`
  - 响应：`{"token": "jwt_token", "user": {"id": "uuid", "email": "user@example.com", "name": "用户名", "role": "merchant"}}`

- `GET /api/auth/profile` - 获取用户信息
  - 响应：`{"id": "uuid", "email": "user@example.com", "name": "用户名", "role": "merchant", "created_at": "2024-01-01T00:00:00Z"}`

### 3.2 酒店管理接口（商户）
- `POST /api/hotels` - 创建酒店
  - 请求体：`{"name_zh": "酒店中文名", "name_en": "Hotel English Name", "address": "酒店地址", "star_rating": 5, "opening_date": "2020-01-01", "description": "酒店描述"}`
  - 响应：`{"id": "uuid", "name_zh": "酒店中文名", "name_en": "Hotel English Name", "status": "pending", ...}`

- `GET /api/hotels/merchant` - 获取商户的酒店列表
  - 查询参数：`?page=1&pageSize=10&status=pending`
  - 响应：`{"data": [{"id": "uuid", "name_zh": "酒店中文名", "status": "pending", ...}], "total": 10, "page": 1, "pageSize": 10}`

- `GET /api/hotels/:id` - 获取酒店详情
  - 响应：`{"id": "uuid", "name_zh": "酒店中文名", "rooms": [...], "images": [...], "facilities": [...], ...}`

- `PUT /api/hotels/:id` - 更新酒店信息
  - 请求体：`{"name_zh": "新酒店名", "address": "新地址", ...}`
  - 响应：`{"id": "uuid", "name_zh": "新酒店名", ...}`

- `POST /api/hotels/:id/rooms` - 添加酒店房型
  - 请求体：`{"name": "豪华大床房", "description": "房型描述", "price": 888.00, "capacity": 2, "quantity": 10}`
  - 响应：`{"id": "uuid", "name": "豪华大床房", "hotel_id": "uuid", ...}`

- `PUT /api/hotels/:id/rooms/:roomId` - 更新酒店房型
  - 请求体：`{"name": "豪华大床房", "price": 999.00, ...}`
  - 响应：`{"id": "uuid", "name": "豪华大床房", "price": 999.00, ...}`

- `DELETE /api/hotels/:id/rooms/:roomId` - 删除酒店房型
  - 响应：`{"success": true, "message": "房型删除成功"}`

- `POST /api/hotels/:id/images` - 添加酒店图片
  - 请求体：`{"url": "https://example.com/image.jpg", "description": "酒店外观", "is_main": true}`
  - 响应：`{"id": "uuid", "url": "https://example.com/image.jpg", ...}`

- `DELETE /api/hotels/:id/images/:imageId` - 删除酒店图片
  - 响应：`{"success": true, "message": "图片删除成功"}`

- `POST /api/hotels/:id/facilities` - 添加酒店设施
  - 请求体：`{"name": "免费WiFi", "description": "全酒店覆盖"}`
  - 响应：`{"id": "uuid", "name": "免费WiFi", ...}`

- `DELETE /api/hotels/:id/facilities/:facilityId` - 删除酒店设施
  - 响应：`{"success": true, "message": "设施删除成功"}`

- `POST /api/hotels/:id/promotions` - 添加酒店优惠
  - 请求体：`{"name": "春节优惠", "description": "春节期间8折", "discount_type": "percentage", "discount_value": 20, "start_date": "2024-02-01", "end_date": "2024-02-15"}`
  - 响应：`{"id": "uuid", "name": "春节优惠", ...}`

- `PUT /api/hotels/:id/promotions/:promotionId` - 更新酒店优惠
  - 请求体：`{"name": "春节特惠", "discount_value": 25, ...}`
  - 响应：`{"id": "uuid", "name": "春节特惠", ...}`

- `DELETE /api/hotels/:id/promotions/:promotionId` - 删除酒店优惠
  - 响应：`{"success": true, "message": "优惠删除成功"}`

- `POST /api/hotels/:id/nearby-attractions` - 添加附近景点
  - 请求体：`{"name": "故宫", "type": "attraction", "distance": "1公里"}`
  - 响应：`{"id": "uuid", "name": "故宫", ...}`

- `DELETE /api/hotels/:id/nearby-attractions/:attractionId` - 删除附近景点
  - 响应：`{"success": true, "message": "景点删除成功"}`

- `POST /api/hotels/:id/tags` - 添加酒店标签
  - 请求体：`{"tag_id": "uuid"}`
  - 响应：`{"id": "uuid", "hotel_id": "uuid", "tag_id": "uuid"}`

- `DELETE /api/hotels/:id/tags/:tagId` - 删除酒店标签
  - 响应：`{"success": true, "message": "标签删除成功"}`

### 3.3 酒店审核接口（管理员）
- `GET /api/admin/hotels` - 获取所有酒店列表（带审核状态）
  - 查询参数：`?page=1&pageSize=10&status=pending`
  - 响应：`{"data": [{"id": "uuid", "name_zh": "酒店中文名", "status": "pending", "merchant_id": "uuid", ...}], "total": 10, "page": 1, "pageSize": 10}`

- `GET /api/admin/hotels/:id` - 获取酒店详情（带审核状态）
  - 响应：`{"id": "uuid", "name_zh": "酒店中文名", "status": "pending", "rejection_reason": null, ...}`

- `PUT /api/admin/hotels/:id/approve` - 审核通过酒店
  - 响应：`{"id": "uuid", "name_zh": "酒店中文名", "status": "approved", ...}`

- `PUT /api/admin/hotels/:id/reject` - 拒绝酒店
  - 请求体：`{"rejection_reason": "酒店资质不符合要求"}`
  - 响应：`{"id": "uuid", "name_zh": "酒店中文名", "status": "rejected", "rejection_reason": "酒店资质不符合要求", ...}`

- `PUT /api/admin/hotels/:id/offline` - 下线酒店
  - 响应：`{"id": "uuid", "name_zh": "酒店中文名", "status": "offline", ...}`

- `PUT /api/admin/hotels/:id/online` - 上线酒店
  - 响应：`{"id": "uuid", "name_zh": "酒店中文名", "status": "approved", ...}`

### 3.4 酒店查询接口（用户端）
- `GET /api/public/hotels` - 获取酒店列表（支持筛选和排序）
  - 查询参数：`?page=1&pageSize=10&sortBy=star_rating&sortOrder=desc&minPrice=200&maxPrice=1000`
  - 响应：`{"data": [{"id": "uuid", "name_zh": "酒店中文名", "star_rating": 5, "min_price": 888.00, ...}], "total": 100, "page": 1, "pageSize": 10}`

- `GET /api/public/hotels/:id` - 获取酒店详情
  - 响应：`{"id": "uuid", "name_zh": "酒店中文名", "rooms": [...], "images": [...], "facilities": [...], "promotions": [...], "nearby_attractions": [...], "tags": [...]}`

- `GET /api/public/hotels/search` - 搜索酒店（支持关键字、地理位置等）
  - 查询参数：`?keyword=故宫&starRating=5&checkInDate=2024-02-01&checkOutDate=2024-02-03`
  - 响应：`{"data": [{"id": "uuid", "name_zh": "酒店中文名", "distance": "1公里", ...}], "total": 10, "page": 1, "pageSize": 10}`

- `GET /api/public/tags` - 获取所有可用标签
  - 响应：`[{"id": "uuid", "name": "亲子", "description": "适合家庭出行"}, ...]`

- `GET /api/public/hotels/filter` - 按标签筛选酒店
  - 查询参数：`?tagIds=uuid1,uuid2&page=1&pageSize=10`
  - 响应：`{"data": [{"id": "uuid", "name_zh": "酒店中文名", "tags": [...], ...}], "total": 20, "page": 1, "pageSize": 10}`

### 3.5 标签管理接口（管理员）
- `GET /api/tags` - 获取所有标签
  - 响应：`[{"id": "uuid", "name": "亲子", "description": "适合家庭出行"}, ...]`

- `POST /api/tags` - 创建标签
  - 请求体：`{"name": "亲子", "description": "适合家庭出行"}`
  - 响应：`{"id": "uuid", "name": "亲子", ...}`

- `PUT /api/tags/:id` - 更新标签
  - 请求体：`{"name": "亲子友好", "description": "适合带孩子出行"}`
  - 响应：`{"id": "uuid", "name": "亲子友好", ...}`

- `DELETE /api/tags/:id` - 删除标签
  - 响应：`{"success": true, "message": "标签删除成功"}`

### 3.6 预订管理接口（管理员/商户）
- `GET /api/reservations` - 获取预订列表
  - 查询参数：`?page=1&pageSize=10&status=confirmed&startDate=2024-02-01&endDate=2024-02-29`
  - 响应：`{"data": [{"id": "uuid", "hotel_id": "uuid", "room_id": "uuid", "guest_name": "张三", "status": "confirmed", ...}], "total": 50, "page": 1, "pageSize": 10}`

- `GET /api/reservations/:id` - 获取预订详情
  - 响应：`{"id": "uuid", "hotel_id": "uuid", "room_id": "uuid", "check_in_date": "2024-02-01", "check_out_date": "2024-02-03", "guest_name": "张三", "guest_phone": "13800138000", "guest_email": "zhangsan@example.com", "status": "confirmed", "total_price": 1776.00, "guests": [...]}`

- `GET /api/reservations/hotel/:hotelId` - 获取酒店的预订列表
  - 查询参数：`?page=1&pageSize=10&status=confirmed`
  - 响应：`{"data": [{"id": "uuid", "room_id": "uuid", "guest_name": "张三", "status": "confirmed", ...}], "total": 20, "page": 1, "pageSize": 10}`

- `PUT /api/reservations/:id/check-in` - 办理入住
  - 请求体：`{"guests": [{"name": "张三", "id_type": "id_card", "id_number": "110101199001011234", "phone": "13800138000"}, ...]}`
  - 响应：`{"id": "uuid", "status": "check_in", "guests": [...]}`

- `PUT /api/reservations/:id/check-out` - 办理退房
  - 响应：`{"id": "uuid", "status": "check_out", ...}`

- `PUT /api/reservations/:id/cancel` - 取消预订
  - 响应：`{"id": "uuid", "status": "cancelled", ...}`

### 3.7 入住人员管理接口（管理员/商户）
- `GET /api/guests` - 获取入住人员列表
  - 查询参数：`?page=1&pageSize=10&startDate=2024-02-01&endDate=2024-02-29`
  - 响应：`{"data": [{"id": "uuid", "name": "张三", "id_type": "id_card", "id_number": "110101199001011234", ...}], "total": 100, "page": 1, "pageSize": 10}`

- `GET /api/guests/:id` - 获取入住人员详情
  - 响应：`{"id": "uuid", "name": "张三", "id_type": "id_card", "id_number": "110101199001011234", "phone": "13800138000", "reservations": [...]}`

- `GET /api/guests/reservation/:reservationId` - 获取预订的入住人员列表
  - 响应：`[{"id": "uuid", "name": "张三", "id_type": "id_card", ...}, ...]`

- `GET /api/guests/hotel/:hotelId` - 获取酒店的入住人员列表
  - 查询参数：`?startDate=2024-02-01&endDate=2024-02-29`
  - 响应：`[{"id": "uuid", "name": "张三", "id_type": "id_card", ...}, ...]`

- `GET /api/guests/room/:roomId` - 获取房间的入住人员列表
  - 查询参数：`?date=2024-02-01`
  - 响应：`[{"id": "uuid", "name": "张三", "id_type": "id_card", ...}, ...]`

- `POST /api/guests` - 添加入住人员信息
  - 请求体：`{"name": "张三", "id_type": "id_card", "id_number": "110101199001011234", "phone": "13800138000"}`
  - 响应：`{"id": "uuid", "name": "张三", "id_type": "id_card", ...}`

- `PUT /api/guests/:id` - 更新入住人员信息
  - 请求体：`{"name": "张三", "phone": "13900139000", ...}`
  - 响应：`{"id": "uuid", "name": "张三", "phone": "13900139000", ...}`

### 3.8 API设计最佳实践

#### 3.8.1 数据验证
- **使用Zod进行请求验证**：确保所有API请求数据符合数据库约束
- **枚举值验证**：严格验证枚举类型值，确保与数据库一致
- **价格精度验证**：验证价格字段为最多2位小数的数字
- **UUID格式验证**：确保所有ID字段为有效的UUID格式

#### 3.8.2 性能优化
- **利用数据库索引**：
  - 用户登录：使用`idx_users_email`索引
  - 酒店列表：使用`idx_hotels_status_star`索引
  - 酒店查询：使用`idx_hotels_merchant_status`索引
  - 房型查询：使用`idx_hotel_rooms_hotel_price`索引
  - 标签筛选：使用`idx_hotel_tag_relations_hotel_tag`索引
  - 预订查询：使用`idx_reservations_hotel_status_date`和`idx_reservations_room_status`索引
  - 入住人员查询：使用`idx_guests_id_number`索引

- **避免N+1查询**：
  - 获取酒店详情时，使用`include`预加载关联数据
  - 获取预订列表时，批量加载关联的客人信息

- **分页查询**：
  - 所有列表接口必须支持分页
  - 使用`LIMIT`和`OFFSET`实现分页
  - 同时返回总数、当前页码和每页大小

#### 3.8.3 数据一致性
- **事务管理**：
  - 办理入住时，使用事务确保入住人员信息和预订状态同时更新
  - 删除酒店时，使用事务处理相关联的数据

- **外键约束**：
  - 严格维护外键关系
  - 删除操作时，考虑级联删除或适当的错误处理

- **状态管理**：
  - 确保状态转换符合业务规则
  - 审核操作时，正确更新状态和相关字段

#### 3.8.4 安全性
- **密码处理**：
  - 密码必须使用bcrypt等算法哈希存储
  - 登录接口返回JWT令牌

- **敏感信息**：
  - 证件号码等敏感信息应加密存储
  - API响应中避免返回敏感信息

- **权限控制**：
  - 基于角色的访问控制
  - 商户只能访问自己的酒店数据
  - 管理员可以访问所有数据

#### 3.8.5 响应格式
- **统一响应格式**：
  - 成功响应：`{"success": true, "data": {...}}`
  - 错误响应：`{"success": false, "error": "错误信息", "code": 400}`
  - 列表响应：`{"data": [...], "total": 100, "page": 1, "pageSize": 10}`

- **HTTP状态码**：
  - 200：成功
  - 201：创建成功
  - 400：请求参数错误
  - 401：未认证
  - 403：无权限
  - 404：资源不存在
  - 500：服务器错误

## 4. 服务层设计

### 4.1 认证服务 (AuthService)
- `register()` - 用户注册
- `login()` - 用户登录
- `validateUser()` - 验证用户
- `getProfile()` - 获取用户信息

### 4.2 酒店服务 (HotelService)
- `createHotel()` - 创建酒店
- `getHotelsByMerchant()` - 获取商户的酒店列表
- `getHotelById()` - 获取酒店详情
- `updateHotel()` - 更新酒店信息
- `deleteHotel()` - 删除酒店

### 4.3 房型服务 (RoomService)
- `createRoom()` - 创建房型
- `updateRoom()` - 更新房型
- `deleteRoom()` - 删除房型
- `getRoomsByHotel()` - 获取酒店的房型列表

### 4.4 图片服务 (ImageService)
- `uploadImage()` - 上传图片
- `deleteImage()` - 删除图片
- `getImagesByHotel()` - 获取酒店的图片列表

### 4.5 设施服务 (FacilityService)
- `createFacility()` - 创建设施
- `deleteFacility()` - 删除设施
- `getFacilitiesByHotel()` - 获取酒店的设施列表

### 4.6 优惠服务 (PromotionService)
- `createPromotion()` - 创建优惠
- `updatePromotion()` - 更新优惠
- `deletePromotion()` - 删除优惠
- `getPromotionsByHotel()` - 获取酒店的优惠列表

### 4.7 附近景点服务 (NearbyAttractionService)
- `createAttraction()` - 创建附近景点
- `deleteAttraction()` - 删除附近景点
- `getAttractionsByHotel()` - 获取酒店的附近景点列表

### 4.8 标签服务 (TagService)
- `createTag()` - 创建标签
- `getAllTags()` - 获取所有标签
- `updateTag()` - 更新标签
- `deleteTag()` - 删除标签
- `addTagToHotel()` - 为酒店添加标签
- `removeTagFromHotel()` - 从酒店移除标签
- `getTagsByHotel()` - 获取酒店的标签列表

### 4.9 审核服务 (VerificationService)
- `getHotelsForVerification()` - 获取待审核的酒店列表
- `approveHotel()` - 审核通过酒店
- `rejectHotel()` - 拒绝酒店
- `offlineHotel()` - 下线酒店
- `onlineHotel()` - 上线酒店

### 4.10 搜索服务 (SearchService)
- `searchHotels()` - 搜索酒店
- `filterHotels()` - 筛选酒店（支持按标签、星级、价格等筛选）
- `sortHotels()` - 排序酒店

### 4.11 预订服务 (ReservationService)
- `createReservation()` - 创建预订
- `getReservations()` - 获取预订列表
- `getReservationById()` - 获取预订详情
- `getReservationsByHotel()` - 获取酒店的预订列表
- `checkIn()` - 办理入住
- `checkOut()` - 办理退房
- `cancelReservation()` - 取消预订

### 4.12 入住人员服务 (GuestService)
- `createGuest()` - 创建入住人员信息
- `getGuests()` - 获取入住人员列表
- `getGuestById()` - 获取入住人员详情
- `getGuestsByReservation()` - 获取预订的入住人员列表
- `getGuestsByHotel()` - 获取酒店的入住人员列表
- `getGuestsByRoom()` - 获取房间的入住人员列表
- `updateGuest()` - 更新入住人员信息

## 5. 中间件和守卫

### 5.1 认证守卫 (AuthGuard)
- 验证JWT令牌
- 提取用户信息

### 5.2 角色守卫 (RoleGuard)
- 验证用户角色
- 控制访问权限

### 5.3 日志中间件 (LoggerMiddleware)
- 记录请求日志
- 记录响应时间

### 5.4 错误处理中间件 (ErrorHandlerMiddleware)
- 统一错误处理
- 格式化错误响应

## 6. 业务流程详细描述

### 6.1 用户注册流程

**前端流程**：
1. 用户填写注册表单（邮箱、密码、用户名、角色）
2. 前端验证表单数据
3. 向后端发送`POST /api/auth/register`请求，携带注册信息

**后端流程**：
1. 接收注册请求
2. 使用Zod验证请求数据
3. 检查邮箱是否已存在
4. 对密码进行bcrypt哈希处理
5. 创建用户记录
6. 生成JWT令牌
7. 返回用户信息和令牌

**数据库操作**：
```prisma
await prisma.user.create({
  data: {
    email: registerData.email,
    password: hashedPassword,
    name: registerData.name,
    role: registerData.role
  }
});
```

### 6.2 用户登录流程

**前端流程**：
1. 用户填写登录表单（邮箱、密码）
2. 前端验证表单数据
3. 向后端发送`POST /api/auth/login`请求，携带登录信息

**后端流程**：
1. 接收登录请求
2. 使用Zod验证请求数据
3. 查找用户记录
4. 验证密码
5. 生成JWT令牌
6. 返回用户信息和令牌

**数据库操作**：
```prisma
await prisma.user.findUnique({
  where: {
    email: loginData.email
  }
});
```

### 6.3 商户创建酒店流程

**前端流程**：
1. 商户填写酒店信息表单（酒店名、地址、星级等）
2. 前端验证表单数据
3. 向后端发送`POST /api/hotels`请求，携带酒店信息
4. 上传酒店图片（如果有）

**后端流程**：
1. 接收创建酒店请求
2. 使用Zod验证请求数据
3. 验证用户身份和权限
4. 创建酒店记录，状态设为`pending`
5. 处理图片上传（如果有）
6. 返回创建的酒店信息

**数据库操作**：
```prisma
await prisma.hotel.create({
  data: {
    name_zh: hotelData.name_zh,
    name_en: hotelData.name_en,
    address: hotelData.address,
    star_rating: hotelData.star_rating,
    opening_date: hotelData.opening_date,
    description: hotelData.description,
    status: 'pending',
    merchant_id: userId
  }
});
```

### 6.4 管理员审核酒店流程

**前端流程**：
1. 管理员访问审核页面
2. 查看待审核酒店列表
3. 点击酒店查看详情
4. 选择审核结果（通过/拒绝）
5. 向后端发送审核请求

**后端流程**：
1. 接收审核请求
2. 验证用户身份和权限
3. 更新酒店状态
4. 如果拒绝，添加拒绝原因
5. 返回更新后的酒店信息

**数据库操作**：
```prisma
// 审核通过
await prisma.hotel.update({
  where: { id: hotelId },
  data: { status: 'approved' }
});

// 拒绝酒店
await prisma.hotel.update({
  where: { id: hotelId },
  data: {
    status: 'rejected',
    rejection_reason: rejectReason
  }
});
```

### 6.5 用户查询酒店流程

**前端流程**：
1. 用户访问酒店查询页面
2. 输入查询条件（关键字、位置、入住日期等）
3. 选择筛选条件（星级、价格等）
4. 点击查询按钮
5. 向后端发送`GET /api/public/hotels/search`请求，携带查询参数

**后端流程**：
1. 接收查询请求
2. 解析查询参数
3. 构建数据库查询
4. 执行查询，获取酒店列表
5. 应用排序和分页
6. 返回酒店列表

**数据库操作**：
```prisma
await prisma.hotel.findMany({
  where: {
    status: 'approved',
    AND: [
      keyword ? {
        OR: [
          { name_zh: { contains: keyword } },
          { name_en: { contains: keyword } },
          { address: { contains: keyword } }
        ]
      } : {},
      starRating ? { star_rating: { equals: starRating } } : {},
      priceMin ? { rooms: { some: { price: { gte: priceMin } } } } : {},
      priceMax ? { rooms: { some: { price: { lte: priceMax } } } } : {}
    ]
  },
  include: {
    rooms: { select: { price: true } },
    images: { where: { is_main: true }, select: { url: true } }
  },
  orderBy: {
    [sortBy]: sortOrder
  },
  skip: (page - 1) * pageSize,
  take: pageSize
});
```

### 6.6 用户按标签筛选酒店流程

**前端流程**：
1. 用户访问酒店查询页面
2. 选择一个或多个标签（如亲子、豪华、免费停车场等）
3. 向后端发送`GET /api/public/hotels/filter`请求，携带标签ID

**后端流程**：
1. 接收筛选请求
2. 解析标签参数
3. 构建数据库查询，使用多对多关系查询
4. 执行查询，获取符合条件的酒店列表
5. 返回酒店列表

**数据库操作**：
```prisma
await prisma.hotel.findMany({
  where: {
    status: 'approved',
    tags: {
      some: {
        tag_id: {
          in: tagIds
        }
      }
    }
  },
  include: {
    rooms: { select: { price: true } },
    images: { where: { is_main: true }, select: { url: true } },
    tags: { include: { tag: true } }
  }
});
```

### 6.7 用户查看酒店详情流程

**前端流程**：
1. 用户点击酒店列表中的酒店
2. 向后端发送`GET /api/public/hotels/:id`请求
3. 接收并显示酒店详情

**后端流程**：
1. 接收详情请求
2. 验证酒店ID
3. 查询酒店详情，包括房型、图片、设施、优惠、附近景点、标签等
4. 返回完整的酒店信息

**数据库操作**：
```prisma
await prisma.hotel.findUnique({
  where: { id: hotelId },
  include: {
    rooms: true,
    images: true,
    facilities: true,
    promotions: {
      where: {
        start_date: { lte: new Date() },
        end_date: { gte: new Date() }
      }
    },
    nearby_attractions: true,
    tags: { include: { tag: true } }
  }
});
```

### 6.8 商户添加酒店标签流程

**前端流程**：
1. 商户访问酒店编辑页面
2. 选择要添加的标签
3. 向后端发送`POST /api/hotels/:id/tags`请求，携带标签ID

**后端流程**：
1. 接收添加标签请求
2. 验证用户身份和权限
3. 验证酒店ID和标签ID
4. 创建酒店-标签关联
5. 返回更新后的酒店标签信息

**数据库操作**：
```prisma
await prisma.hotel_tag_relation.create({
  data: {
    hotel_id: hotelId,
    tag_id: tagId
  }
});
```

### 6.9 管理员上下线酒店流程

**前端流程**：
1. 管理员访问酒店管理页面
2. 选择要下线/上线的酒店
3. 点击下线/上线按钮
4. 向后端发送相应的请求

**后端流程**：
1. 接收上下线请求
2. 验证用户身份和权限
3. 更新酒店状态
4. 返回更新后的酒店信息

**数据库操作**：
```prisma
// 下线酒店
await prisma.hotel.update({
  where: { id: hotelId },
  data: { status: 'offline' }
});

// 上线酒店
await prisma.hotel.update({
  where: { id: hotelId },
  data: { status: 'approved' }
});
```

### 6.10 预订流程

**前端流程**：
1. 用户选择酒店和房型
2. 填写入住日期、退房日期和联系人信息
3. 向后端发送预订请求

**后端流程**：
1. 接收预订请求
2. 验证请求数据
3. 检查房间是否可用
4. 创建预订记录
5. 返回预订信息

**数据库操作**：
```prisma
await prisma.reservation.create({
  data: {
    hotel_id: reservationData.hotel_id,
    room_id: reservationData.room_id,
    check_in_date: reservationData.check_in_date,
    check_out_date: reservationData.check_out_date,
    guest_name: reservationData.guest_name,
    guest_phone: reservationData.guest_phone,
    guest_email: reservationData.guest_email,
    status: 'confirmed',
    total_price: reservationData.total_price
  }
});
```

### 6.11 办理入住流程

**前端流程**：
1. 前台人员输入预订信息或客人信息
2. 填写入住人员证件信息
3. 向后端发送办理入住请求

**后端流程**：
1. 接收办理入住请求
2. 验证预订信息
3. 添加入住人员信息
4. 更新预订状态为`check_in`
5. 返回办理结果

**数据库操作**：
```prisma
// 添加入住人员
const guest = await prisma.guest.create({
  data: {
    name: guestData.name,
    id_type: guestData.id_type,
    id_number: guestData.id_number,
    phone: guestData.phone
  }
});

// 关联入住人员和预订
await prisma.reservation_guest.create({
  data: {
    reservation_id: reservationId,
    guest_id: guest.id
  }
});

// 更新预订状态
await prisma.reservation.update({
  where: { id: reservationId },
  data: { status: 'check_in' }
});
```

### 6.12 查询房间入住人员信息流程

**前端流程**：
1. 管理员或商户访问后台管理系统
2. 选择酒店或房间
3. 选择日期范围
4. 点击查询按钮
5. 向后端发送查询请求

**后端流程**：
1. 接收查询请求
2. 验证用户身份和权限
3. 解析查询参数
4. 构建数据库查询
5. 执行查询，获取入住人员信息
6. 返回入住人员列表

**数据库操作**：
```prisma
await prisma.guest.findMany({
  where: {
    reservations: {
      some: {
        reservation: {
          AND: [
            hotelId ? { hotel_id: hotelId } : {},
            roomId ? { room_id: roomId } : {},
            startDate ? {
              check_in_date: {
                lte: endDate || new Date()
              }
            } : {},
            endDate ? {
              check_out_date: {
                gte: startDate || new Date()
              }
            } : {},
            status: {
              in: ['confirmed', 'check_in']
            }
          ]
        }
      }
    }
  },
  include: {
    reservations: {
      include: {
        reservation: {
          select: {
            hotel_id: true,
            room_id: true,
            check_in_date: true,
            check_out_date: true,
            status: true
          }
        }
      }
    }
  }
});
```

## 7. 技术实现要点

### 7.1 技术栈选择

* **后端语言**: Node.js
* **框架**: Nest.js
* **ORM**: Prisma
* **数据库**: PostgreSQL
* **认证**: JWT
* **验证**: Zod
* **缓存**: Redis（可选）

### 7.2 Nest.js 实现

* 使用模块化设计
* 实现依赖注入
* 使用装饰器定义路由和控制器
* 实现中间件和守卫

### 7.3 Prisma ORM 实现

* 定义数据模型和关系
* 实现高效的数据库查询
* 使用事务确保数据一致性
* 生成类型安全的查询构建器

### 7.4 PostgreSQL 实现

* 使用UUID作为主键
* 实现适当的索引
* 使用枚举类型存储状态和类型
* 实现JSONB类型存储复杂数据（可选）

### 7.5 认证与授权实现

* 使用JWT进行身份验证
* 实现基于角色的访问控制（RBAC）
* 密码使用bcrypt进行哈希存储
* 实现令牌过期和刷新机制

### 7.6 PostgreSQL 18 特定实现

* **UUID支持**：需要先安装`uuid-ossp`扩展
  ```sql
  CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
  ```

* **Enum类型实现**：
  ```sql
  -- 用户角色枚举
  CREATE TYPE user_role AS ENUM ('merchant', 'admin');
  
  -- 酒店状态枚举
  CREATE TYPE hotel_status AS ENUM ('pending', 'approved', 'rejected', 'offline');
  
  -- 优惠类型枚举
  CREATE TYPE discount_type AS ENUM ('percentage', 'fixed', 'package');
  
  -- 附近景点类型枚举
  CREATE TYPE attraction_type AS ENUM ('attraction', 'transportation', 'shopping');
  
  -- 预订状态枚举
  CREATE TYPE reservation_status AS ENUM ('confirmed', 'check_in', 'check_out', 'cancelled');
  
  -- 证件类型枚举
  CREATE TYPE id_type AS ENUM ('id_card', 'passport', 'other');
  ```

### 7.6 数据验证实现

* 使用Zod进行请求数据验证
* 实现自定义验证规则
* 统一错误处理和错误响应

### 7.7 性能优化实现

* 数据库索引优化
* API响应缓存
* 分页查询实现
* 延迟加载关联数据

### 7.8 安全性实现

* 防止SQL注入攻击
* 防止XSS攻击
* 防止CSRF攻击
* 实现API速率限制
* 保护敏感信息（如证件号码）

### 7.9 部署与监控实现

* 使用Docker容器化
* 实现CI/CD流水线
* 配置日志和监控
* 实现健康检查端点

## 8. 项目结构

```
src/
├── auth/
│   ├── auth.controller.ts
│   ├── auth.service.ts
│   ├── auth.guard.ts
│   ├── auth.module.ts
│   └── dto/
├── hotels/
│   ├── hotels.controller.ts
│   ├── hotels.service.ts
│   ├── hotels.module.ts
│   ├── dto/
│   └── entities/
├── rooms/
│   ├── rooms.controller.ts
│   ├── rooms.service.ts
│   ├── rooms.module.ts
│   ├── dto/
│   └── entities/
├── images/
│   ├── images.controller.ts
│   ├── images.service.ts
│   ├── images.module.ts
│   ├── dto/
│   └── entities/
├── facilities/
│   ├── facilities.controller.ts
│   ├── facilities.service.ts
│   ├── facilities.module.ts
│   ├── dto/
│   └── entities/
├── promotions/
│   ├── promotions.controller.ts
│   ├── promotions.service.ts
│   ├── promotions.module.ts
│   ├── dto/
│   └── entities/
├── nearby-attractions/
│   ├── nearby-attractions.controller.ts
│   ├── nearby-attractions.service.ts
│   ├── nearby-attractions.module.ts
│   ├── dto/
│   └── entities/
├── tags/
│   ├── tags.controller.ts
│   ├── tags.service.ts
│   ├── tags.module.ts
│   ├── dto/
│   └── entities/
├── reservations/
│   ├── reservations.controller.ts
│   ├── reservations.service.ts
│   ├── reservations.module.ts
│   ├── dto/
│   └── entities/
├── guests/
│   ├── guests.controller.ts
│   ├── guests.service.ts
│   ├── guests.module.ts
│   ├── dto/
│   └── entities/
├── admin/
│   ├── admin.controller.ts
│   ├── admin.service.ts
│   ├── admin.guard.ts
│   ├── admin.module.ts
│   └── dto/
├── public/
│   ├── public.controller.ts
│   ├── public.service.ts
│   └── public.module.ts
├── common/
│   ├── middleware/
│   ├── guards/
│   ├── filters/
│   └── utils/
├── config/
│   └── configuration.ts
├── database/
│   ├── prisma.service.ts
│   └── seed.ts
└── main.ts
```

## 9. 技术实现细节

### 9.1 数据库索引设计

**建议索引：**
- `users(email)` - 优化用户登录查询
- `hotels(status, star_rating)` - 优化酒店列表查询
- `hotels(merchant_id, status)` - 优化商户酒店查询
- `hotel_rooms(hotel_id, price)` - 优化房型价格查询
- `hotel_tag_relations(hotel_id, tag_id)` - 优化标签筛选查询
- `reservations(hotel_id, status, check_in_date, check_out_date)` - 优化预订查询
- `reservations(room_id, status)` - 优化房间预订查询
- `reservation_guests(reservation_id, guest_id)` - 优化预订与入住人员关联查询
- `guests(id_number)` - 优化入住人员证件查询

### 9.2 PostgreSQL 18 完整初始化脚本

```sql
-- 1. 创建数据库
CREATE DATABASE yisu_hotel_booking;

-- 连接到数据库后执行以下脚本

-- 2. 安装UUID扩展
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 3. 创建枚举类型
CREATE TYPE user_role AS ENUM ('merchant', 'admin');
CREATE TYPE hotel_status AS ENUM ('pending', 'approved', 'rejected', 'offline');
CREATE TYPE discount_type AS ENUM ('percentage', 'fixed', 'package');
CREATE TYPE attraction_type AS ENUM ('attraction', 'transportation', 'shopping');
CREATE TYPE reservation_status AS ENUM ('confirmed', 'check_in', 'check_out', 'cancelled');
CREATE TYPE id_type AS ENUM ('id_card', 'passport', 'other');

-- 4. 创建用户表
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    name VARCHAR(100) NOT NULL,
    role user_role NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
CREATE INDEX idx_users_email ON users(email);

-- 5. 创建酒店表
CREATE TABLE hotels (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name_zh VARCHAR(255) NOT NULL,
    name_en VARCHAR(255) NOT NULL,
    address TEXT NOT NULL,
    star_rating INTEGER NOT NULL,
    opening_date DATE NOT NULL,
    description TEXT,
    status hotel_status NOT NULL,
    rejection_reason TEXT,
    merchant_id UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
CREATE INDEX idx_hotels_status_star ON hotels(status, star_rating);
CREATE INDEX idx_hotels_merchant_status ON hotels(merchant_id, status);

-- 6. 创建酒店房型表
CREATE TABLE hotel_rooms (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    hotel_id UUID REFERENCES hotels(id),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL,
    capacity INTEGER NOT NULL,
    quantity INTEGER NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
CREATE INDEX idx_hotel_rooms_hotel_price ON hotel_rooms(hotel_id, price);

-- 7. 创建酒店设施表
CREATE TABLE hotel_facilities (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    hotel_id UUID REFERENCES hotels(id),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 8. 创建酒店图片表
CREATE TABLE hotel_images (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    hotel_id UUID REFERENCES hotels(id),
    url VARCHAR(500) NOT NULL,
    description TEXT,
    is_main BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 9. 创建酒店优惠表
CREATE TABLE hotel_promotions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    hotel_id UUID REFERENCES hotels(id),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    discount_type discount_type NOT NULL,
    discount_value DECIMAL(10,2) NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 10. 创建酒店附近景点表
CREATE TABLE hotel_nearby_attractions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    hotel_id UUID REFERENCES hotels(id),
    name VARCHAR(100) NOT NULL,
    type attraction_type NOT NULL,
    distance VARCHAR(50),
    created_at TIMESTAMP DEFAULT NOW()
);

-- 11. 创建酒店标签表
CREATE TABLE hotel_tags (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(50) NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 12. 创建酒店-标签关联表
CREATE TABLE hotel_tag_relations (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    hotel_id UUID REFERENCES hotels(id),
    tag_id UUID REFERENCES hotel_tags(id),
    created_at TIMESTAMP DEFAULT NOW()
);
CREATE INDEX idx_hotel_tag_relations_hotel_tag ON hotel_tag_relations(hotel_id, tag_id);

-- 13. 创建预订表
CREATE TABLE reservations (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    hotel_id UUID REFERENCES hotels(id),
    room_id UUID REFERENCES hotel_rooms(id),
    check_in_date DATE NOT NULL,
    check_out_date DATE NOT NULL,
    guest_name VARCHAR(50) NOT NULL,
    guest_phone VARCHAR(20) NOT NULL,
    guest_email VARCHAR(255) NOT NULL,
    status reservation_status NOT NULL,
    total_price DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
CREATE INDEX idx_reservations_hotel_status_date ON reservations(hotel_id, status, check_in_date, check_out_date);
CREATE INDEX idx_reservations_room_status ON reservations(room_id, status);

-- 14. 创建入住人员表
CREATE TABLE guests (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(50) NOT NULL,
    id_type id_type NOT NULL,
    id_number VARCHAR(50) NOT NULL,
    phone VARCHAR(20) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
CREATE INDEX idx_guests_id_number ON guests(id_number);

-- 15. 创建预订-入住人员关联表
CREATE TABLE reservation_guests (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    reservation_id UUID REFERENCES reservations(id),
    guest_id UUID REFERENCES guests(id),
    created_at TIMESTAMP DEFAULT NOW()
);
CREATE INDEX idx_reservation_guests_reservation_guest ON reservation_guests(reservation_id, guest_id);
```

### 9.2 API设计最佳实践

* **RESTful设计**：遵循RESTful API设计原则，使用合适的HTTP方法和状态码
* **版本控制**：在API路径中包含版本号，如`/api/v1/hotels`
* **分页**：对所有列表API实现分页，使用`page`和`pageSize`参数
* **排序**：对列表API实现排序，使用`sortBy`和`sortOrder`参数
* **筛选**：实现灵活的筛选机制，使用查询参数传递筛选条件
* **响应格式**：统一API响应格式，包含`success`、`data`和`error`字段
* **错误处理**：实现统一的错误处理机制，返回标准化的错误响应

### 9.3 安全性最佳实践

* **输入验证**：对所有用户输入进行严格验证，使用Zod模式验证
* **密码安全**：使用bcrypt对密码进行哈希存储，设置适当的哈希强度
* **敏感信息保护**：对敏感信息（如证件号码）进行加密存储
* **API认证**：使用JWT进行API认证，设置合理的令牌过期时间
* **权限控制**：实现基于角色的访问控制，确保用户只能访问授权的资源
* **HTTPS**：在生产环境中使用HTTPS加密传输
* **速率限制**：实现API速率限制，防止暴力攻击
* **日志记录**：记录所有关键操作和安全事件，便于审计和监控

### 9.4 性能优化最佳实践

* **数据库查询优化**：使用Prisma的include和select优化查询，避免N+1查询问题
* **缓存策略**：对频繁访问的数据（如酒店列表、标签列表）实现缓存
* **代码优化**：避免不必要的计算和操作，优化算法复杂度
* **异步处理**：使用异步/等待模式处理IO操作，提高并发性能
* **资源管理**：正确管理数据库连接、文件句柄等资源，避免资源泄漏
* **负载均衡**：在高流量场景下实现负载均衡

## 10. 结论

本设计方案完全符合用户需求，提供了一个完整的后端系统架构：

1. **功能完整性**：覆盖了用户端和管理端的所有功能需求，包括酒店查询、筛选、预订管理和入住人员信息查询
2. **数据维度完整性**：包含了所有必须维度和可选维度的数据，支持酒店信息、标签、预订和入住人员信息的管理
3. **角色权限完整性**：实现了商户、管理员和用户的角色分离和权限控制
4. **技术栈符合要求**：使用了Node.js、Nest.js、Prisma和PostgreSQL
5. **架构合理性**：采用了模块化、分层架构，确保了系统的可扩展性、可维护性和安全性
6. **性能优化**：实现了数据库索引、缓存策略等性能优化措施
7. **安全性**：实现了输入验证、密码哈希、权限控制等安全措施

该设计方案已经准备就绪，可以进行实际的代码实现。通过严格按照设计方案进行开发，可以构建一个高质量、高性能的酒店预订平台后端系统。